# M365 è—ç‰™ä½åŠŸè€—å‡½å¼åº«

![MIT license](https://img.shields.io/github/license/zero2005x/m365)
![Crates.io version](https://img.shields.io/crates/v/m365)

é€é BLEï¼ˆè—ç‰™ä½åŠŸè€—ï¼‰èˆ‡å°ç±³ç±³å®¶ M365 é›»å‹•æ»‘æ¿è»Šé€šè¨Šçš„è¼•é‡ç´š Rust å‡½å¼åº«ã€‚

> ğŸ“– **[English Documentation](../README.md)**

## åŠŸèƒ½ç‰¹è‰²

- ğŸ” **æƒæå™¨** - å°‹æ‰¾é™„è¿‘çš„ M365 æ»‘æ¿è»Š
- ğŸ” **è¨»å†Š** - ä½¿ç”¨ ECDH é‡‘é‘°äº¤æ›èˆ‡æ»‘æ¿è»Šé…å°
- ğŸ”‘ **ç™»å…¥** - ä½¿ç”¨å·²å„²å­˜çš„ Token èªè­‰
- ğŸ“Š **è®€å–è³‡æ–™** - é›»æ± ã€é€Ÿåº¦ã€é‡Œç¨‹ã€æº«åº¦ç­‰
- âš™ï¸ **è¨­å®š** - æ§åˆ¶å®šé€Ÿå·¡èˆªã€å°¾ç‡ˆã€å‹•èƒ½å›æ”¶ç­‰ç´š
- ğŸ® **äº’å‹•æ§åˆ¶å™¨** - å³æ™‚ç›£æ§èˆ‡æ§åˆ¶

## æ”¯æ´å¹³å°

æœ¬å‡½å¼åº«ä½¿ç”¨ [btleplug](https://crates.io/crates/btleplug) æä¾›è·¨å¹³å° BLE æ”¯æ´ï¼š

- Windows 10/11
- macOS
- Linux
- iOS

## æ”¯æ´çš„æ»‘æ¿è»Šå‹è™Ÿ

| å‹è™Ÿ          | ç‹€æ…‹    |
| ------------- | ------- |
| å°ç±³ M365     | âœ… æ”¯æ´ |
| å°ç±³ Mi 1S    | âœ… æ”¯æ´ |
| å°ç±³ Mi Pro   | âœ… æ”¯æ´ |
| å°ç±³ Mi Pro 2 | âœ… æ”¯æ´ |
| å°ç±³ Mi Pro 3 | âœ… æ”¯æ´ |
| å‰¯å» æ§åˆ¶å™¨    | âš ï¸ éƒ¨åˆ† |

## å¿«é€Ÿé–‹å§‹

### å®‰è£

åœ¨ `Cargo.toml` ä¸­æ·»åŠ ï¼š

```toml
[dependencies]
m365 = "0.1"
```

### ä½¿ç”¨ç¯„ä¾‹

#### 1. å°‹æ‰¾ MAC ä½å€

```bash
cargo run --example scanner
```

è¼¸å‡ºï¼š

```
INFO scanner: Found scooter nearby: MIScooter7353 with mac: D5:01:45:37:ED:FD
```

#### 2. è¨»å†Šï¼ˆåƒ…é¦–æ¬¡ï¼‰

âš ï¸ **è­¦å‘Šï¼š** è¨»å†Šæœƒè§£é™¤èˆ‡å…¶ä»–æ‡‰ç”¨ç¨‹å¼çš„é…å°ï¼

```bash
cargo run --example register D5:01:45:37:ED:FD
```

é€™æœƒå°‡èªè­‰ Token å„²å­˜åˆ° `.mi-token` æª”æ¡ˆã€‚

#### 3. ç™»å…¥

```bash
cargo run --example login D5:01:45:37:ED:FD
```

#### 4. è®€å–è³‡è¨Š

```bash
cargo run --example about D5:01:45:37:ED:FD
```

è¼¸å‡ºï¼š

```
Battery info: BatteryInfo { capacity: 7392, percent: 63, voltage: 36.74 }
Serial number: 26354/00467353
Motor info: MotorInfo { speed_kmh: 0, total_distance_m: 1306083 }
```

#### 5. äº’å‹•æ§åˆ¶å™¨

```bash
cargo run --example controller D5:01:45:37:ED:FD
```

## BLE å”è­°

### æœå‹™èˆ‡ç‰¹å¾µå€¼

| UUID           | åç¨±     | æè¿°                    |
| -------------- | -------- | ----------------------- |
| `FE95`         | èªè­‰æœå‹™ | å°ç±³èªè­‰æœå‹™            |
| `0x0010`       | UPNP     | å‘½ä»¤æ§åˆ¶                |
| `0x0019`       | AVDTP    | è³‡æ–™äº¤æ›                |
| `6e400002-...` | TX       | å¯«å…¥ï¼ˆå®¢æˆ¶ç«¯ â†’ æ»‘æ¿è»Šï¼‰ |
| `6e400003-...` | RX       | é€šçŸ¥ï¼ˆæ»‘æ¿è»Š â†’ å®¢æˆ¶ç«¯ï¼‰ |

### UART è¨Šæ¡†æ ¼å¼

```
+-----+-----+-----+-----+-----+-----+-------+------+------+
| 0x55| 0xAA|  L  |  D  |  T  |  C  |  ...  | CK0  | CK1  |
+-----+-----+-----+-----+-----+-----+-------+------+------+
  æ¨™é ­      é•·åº¦  è£ç½®  å‘½ä»¤  å±¬æ€§   è³‡æ–™    æ ¡é©—ç¢¼
```

| æ¬„ä½        | æè¿°                                         |
| ----------- | -------------------------------------------- |
| `0x55 0xAA` | è¨Šæ¡†æ¨™é ­                                     |
| `L`         | é•·åº¦ = è³‡æ–™é•·åº¦ + 2                          |
| `D`         | è£ç½®ï¼š`0x20`=ä¸»æ©Ÿ â†’ é¦¬é”ï¼Œ`0x22`=ä¸»æ©Ÿ â†’ é›»æ±  |
| `T`         | é¡å‹ï¼š`0x01`=è®€å–ï¼Œ`0x03`=å¯«å…¥               |
| `CK0, CK1`  | æ ¡é©—ç¢¼ = (å¾ L é–‹å§‹çš„ä½å…ƒçµ„ç¸½å’Œ) XOR 0xFFFF  |

## åŠ å¯†æµç¨‹

### è¨»å†Šï¼ˆä¸€æ¬¡æ€§ï¼‰

```
å®¢æˆ¶ç«¯                              æ»‘æ¿è»Š
  â”‚                                   â”‚
  â”‚â”€â”€â”€â”€ CMD_GET_INFO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚â—„â”€â”€â”€â”€ é ç«¯è³‡è¨Š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                                   â”‚
  â”‚  ç”¢ç”Ÿ ECDH é‡‘é‘°å° (P-256)         â”‚
  â”‚â”€â”€â”€â”€ æˆ‘çš„å…¬é‘° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚â—„â”€â”€â”€â”€ æ»‘æ¿è»Šå…¬é‘° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                                   â”‚
  â”‚  è¨ˆç®—ï¼š                           â”‚
  â”‚  - å…±äº«å¯†é‘° (ECDH)                â”‚
  â”‚  - Token, BindKey (HKDF-SHA256)   â”‚
  â”‚  - DID_CT (AES-CCM åŠ å¯†)          â”‚
  â”‚                                   â”‚
  â”‚â”€â”€â”€â”€ DID_CT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚â—„â”€â”€â”€â”€ AUTH_OK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                                   â”‚
  â”‚  å„²å­˜ Token (12 ä½å…ƒçµ„)           â”‚
```

### ç™»å…¥ï¼ˆæ¯æ¬¡é€£ç·šï¼‰

```
å®¢æˆ¶ç«¯                              æ»‘æ¿è»Š
  â”‚                                   â”‚
  â”‚â”€â”€â”€â”€ CMD_LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚â”€â”€â”€â”€ éš¨æ©Ÿé‡‘é‘° (16 ä½å…ƒçµ„) â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚â—„â”€â”€â”€â”€ é ç«¯éš¨æ©Ÿé‡‘é‘° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚â—„â”€â”€â”€â”€ é ç«¯è³‡è¨Š (32 ä½å…ƒçµ„) â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                                   â”‚
  â”‚  æ´¾ç”Ÿé‡‘é‘° (HKDF-SHA256)ï¼š         â”‚
  â”‚  - DevKey, AppKey (AES-128)       â”‚
  â”‚  - DevIV, AppIV (å„ 4 ä½å…ƒçµ„)     â”‚
  â”‚                                   â”‚
  â”‚  é©—è­‰ï¼šHMAC(DevKey, salt)         â”‚
  â”‚                                   â”‚
  â”‚â”€â”€â”€â”€ DID è³‡è¨Š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚â—„â”€â”€â”€â”€ LOGIN_OK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
```

### UART åŠ å¯† (AES-128-CCM)

```
åŠ å¯†ï¼ˆå®¢æˆ¶ç«¯ â†’ æ»‘æ¿è»Šï¼‰ï¼š
  nonce = AppIV + "0000" + è¨ˆæ•¸å™¨
  å¯†æ–‡ = AES-CCM(AppKey, è¨Šæ¯, nonce)

è§£å¯†ï¼ˆæ»‘æ¿è»Š â†’ å®¢æˆ¶ç«¯ï¼‰ï¼š
  nonce = DevIV + "0000" + è¨ˆæ•¸å™¨
  æ˜æ–‡ = AES-CCM(DevKey, å¯†æ–‡, nonce)
```

## å¯è®€å–çš„è³‡æ–™

| é¡åˆ¥ | è³‡æ–™                                     |
| ---- | ---------------------------------------- |
| é¦¬é” | é€Ÿåº¦ã€å¹³å‡é€Ÿåº¦ã€é‡Œç¨‹ã€é‹è¡Œæ™‚é–“ã€æº«åº¦     |
| é›»æ±  | é›»å£“ã€é›»æµã€å®¹é‡ã€ç™¾åˆ†æ¯”ã€é›»èŠ¯é›»å£“ã€æº«åº¦ |
| è¨­å®š | å®šé€Ÿå·¡èˆªã€å°¾ç‡ˆã€å‹•èƒ½å›æ”¶ç­‰ç´š             |
| è³‡è¨Š | åºè™Ÿã€PIN ç¢¼ã€éŸŒé«”ç‰ˆæœ¬                   |

## API åƒè€ƒ

### æƒæå™¨

```rust
use m365::scanner::ScooterScanner;

let scanner = ScooterScanner::new().await?;
let scooters = scanner.scooters().await;
```

### è¨»å†Š

```rust
use m365::register::MiRegister;

let device = scanner.connect_to("D5:01:45:37:ED:FD").await?;
let mut register = MiRegister::new(&device).await?;
let token = register.register().await?;
```

### ç™»å…¥èˆ‡æœƒè©±

```rust
use m365::login::MiLogin;

let mut login = MiLogin::new(&device, &token).await?;
let session = login.start().await?;

// è®€å–è³‡æ–™
let battery = session.battery_info().await?;
let motor = session.motor_info().await?;
```

## å°ˆæ¡ˆçµæ§‹

```
m365/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ lib.rs           # å‡½å¼åº«å…¥å£
â”‚   â”œâ”€â”€ scanner.rs       # BLE è£ç½®æƒæ
â”‚   â”œâ”€â”€ connection.rs    # BLE é€£ç·šç®¡ç†
â”‚   â”œâ”€â”€ protocol.rs      # MiAuth å”è­°å¯¦ä½œ
â”‚   â”œâ”€â”€ register.rs      # è£ç½®è¨»å†Š
â”‚   â”œâ”€â”€ login.rs         # èªè­‰
â”‚   â”œâ”€â”€ mi_crypto.rs     # åŠ å¯†æ“ä½œ
â”‚   â”œâ”€â”€ consts.rs        # å¸¸æ•¸
â”‚   â””â”€â”€ session/         # æœƒè©±å‘½ä»¤
â”‚       â”œâ”€â”€ mi_session.rs
â”‚       â”œâ”€â”€ battery.rs
â”‚       â”œâ”€â”€ info.rs
â”‚       â”œâ”€â”€ settings.rs
â”‚       â””â”€â”€ commands.rs
â”œâ”€â”€ examples/
â”‚   â”œâ”€â”€ scanner.rs       # å°‹æ‰¾æ»‘æ¿è»Š
â”‚   â”œâ”€â”€ register.rs      # è¨»å†Šæ»‘æ¿è»Š
â”‚   â”œâ”€â”€ login.rs         # ç™»å…¥ç¯„ä¾‹
â”‚   â”œâ”€â”€ about.rs         # è®€å–æ‰€æœ‰è³‡è¨Š
â”‚   â”œâ”€â”€ settings.rs      # è®Šæ›´è¨­å®š
â”‚   â””â”€â”€ controller.rs    # äº’å‹•æ§åˆ¶å™¨
â””â”€â”€ tests/
    â”œâ”€â”€ crypto_test.rs
    â”œâ”€â”€ motor_info_test.rs
    â””â”€â”€ uart_test.rs
```

## æˆæ¬Š

æœ¬å°ˆæ¡ˆæ¡ç”¨ MIT æˆæ¬Š - è©³è¦‹ [LICENSE.md](../LICENSE.md) æª”æ¡ˆã€‚

## è‡´è¬

- åŸºæ–¼ [CamiAlfa's M365-BLE-PROTOCOL](https://github.com/CamiAlfa/M365-BLE-PROTOCOL) çš„ç ”ç©¶
- ä½¿ç”¨ [btleplug](https://crates.io/crates/btleplug) æä¾›è·¨å¹³å° BLE æ”¯æ´
